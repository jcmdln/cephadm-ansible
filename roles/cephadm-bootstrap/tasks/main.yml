# tasks file for cephadm-bootstrap

- name: Create /etc/ceph directory
  file:
    path: /etc/ceph
    state: directory
  register: cephadm_config_dir

- name: Generate ceph.conf, deploy mgr/mons daemons
  command: >-
    cephadm bootstrap
    --allow-fqdn-hostname
    --skip-dashboard
    --skip-firewalld
    --skip-mon-network
    --skip-monitoring-stack
    --mon-ip {{ ansible_facts[cephadm_network_interface_public][cephadm_network_ip_version].address }}
  when: cephadm_config_dir.changed == 'False'

- name: Add cephadm key to all other hosts
  shell: >-
    ssh-copy-id -f
    -i /etc/ceph/ceph.pub
    -o 'IdentityFile ~/.ssh/cephadm_rsa'
    {{ item }}
  changed_when:
    - result.rc is defined
    - result.rc > 0
  register: result
  when: (cephadm_hosts | length) > 0
  with_items: "{{ cephadm_hosts | difference(inventory_hostname) }}"

- name: Enable 'cephadm' orchestrator module
  command: >-
    ceph mgr module enable cephadm
  changed_when:
    - result.rc is defined
    - result.rc > 0
  register: result

- name: Use 'cephadm' as orchestrator backend
  command: >-
    ceph orch set backend cephadm
  changed_when:
    - result.rc is defined
    - result.rc > 0
  register: result

- name: Add other hosts to the cluster
  command: >-
    ceph orch host add {{ item }}
  changed_when:
    - result.rc is defined
    - result.rc > 0
  register: result
  when: (cephadm_hosts | length) > 0
  with_items: "{{ cephadm_hosts | difference(inventory_hostname) }}"
