# tasks file for cephadm-bootstrap

- name: Create /etc/ceph directory
  file:
    path: /etc/ceph
    state: directory

- name: Check if /etc/ceph/ceph.conf exists
  stat:
    path: /etc/ceph/ceph.conf
  register: cephadm_check_ceph_conf

- name: Bootstrap Ceph
  cephadm_bootstrap:
    mon_ip: "{{ ansible_facts[interface][ipv].address }}"
    allow_fqdn_hostname: true
    skip_dashboard: true
    skip_firewalld: true
    skip_mon_network: true
    skip_monitoring_stack: true
  vars:
    ipv: "{{ cephadm_network_ip_version }}"
    interface: "{{ cephadm_network_interface_public }}"
  when: not cephadm_check_ceph_conf.stat.exists

- name: Show output of 'ceph status' for debugging, if needed
  command: >-
    ceph status
  changed_when:
    - result.rc is defined
    - result.rc > 0
  register: result

- name: Add cephadm pubkey to all other hosts
  shell: >-
    ssh-copy-id -f
    -i /etc/ceph/ceph.pub
    -o 'IdentityFile ~/.ssh/cephadm_rsa'
    {{ item }}
  changed_when:
    - result.rc is defined
    - result.rc > 0
  register: result
  when: (cephadm_hosts | length) > 0
  with_items: "{{ cephadm_hosts | difference(inventory_hostname) }}"

- name: Enable 'cephadm' orchestrator module
  command: >-
    ceph mgr module enable cephadm
  changed_when:
    - result.rc is defined
    - result.rc > 0
  register: result

- name: Use 'cephadm' as orchestrator backend
  command: >-
    ceph orch set backend cephadm
  changed_when:
    - result.rc is defined
    - result.rc > 0
  register: result

- name: Add other hosts to the cluster
  command: >-
    ceph orch host add {{ item }}
  changed_when:
    - result.rc is defined
    - result.rc > 0
  register: result
  when: (cephadm_hosts | length) > 0
  with_items: "{{ cephadm_hosts | difference(inventory_hostname) }}"
