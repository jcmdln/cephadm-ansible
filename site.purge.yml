# site.purge.yml
#
# To purge a cluster, you must run the following:
#
#   ansible-playbook -i inventory.yml site.purge.yml \
#     --tags yes-i-really-really-mean-it \
#     --extra-vars "cephadm_cluster_fsid=<fsid>"
#
##

- name: Purge Ceph from all defined hosts
  any_errors_fatal: true
  gather_facts: false
  hosts: all
  tags: [never, yes-i-really-really-mean-it]

  pre_tasks:
    - name: check if /cephadm exists
      stat:
        path: /usr/local/sbin/cephadm
      register: cephadm_installed

    - name: check if /etc/ceph/ceph.conf exists
      stat:
        path: /etc/ceph/ceph.conf
      register: cephadm_deployed

    - name: Fail if cephadm isn't installed and deployed
      fail:
        msg: >-
          Ceph does not appear to be deployed.  If Ceph really is
          installed on the specified hosts, you may have to intervene
          manually.
      when:
        - not cephadm_installed
        - not cephadm_deployed

  tasks:
    - name: Destroy a cluster
      command: >-
        cephadm shell -- ceph rm-cluster --force
        {{ cephadm_cluster_fsid }}
      failed_when: false
      register: result

    - name: Cleanup vgs
      command: >-
        vgremove -y ceph-*
      failed_when: false
      register: result

    - name: Stop all running docker containers
      shell: >-
        docker ps | grep -v grep | grep -i ceph | awk '{print $1}' | xargs docker stop
      failed_when: false
      register: result

    - name: Docker system prune
      command: >-
        docker system prune -af
      failed_when: false
      register: result

    - name: Delete Ceph directories
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /etc/ceph
        - /var/lib/ceph

    - name: Uninstall packages
      package:
        name: "{{ cephadm_host_packages }}"
        state: absent
